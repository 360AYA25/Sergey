#!/bin/bash

# ðŸ”’ Pre-commit hook - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼
# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°: ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² .git/hooks/pre-commit Ð¸ chmod +x

echo "ðŸ” Running pre-commit checks..."

# ============================================
# 1ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° credentials Ð² staged Ñ„Ð°Ð¹Ð»Ð°Ñ…
# ============================================

echo "  Checking for credentials..."

# Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ð¾Ð² Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ°
PATTERNS=(
  "SUPABASE_ANON_KEY"
  "TELEGRAM_BOT_TOKEN"
  "OPENAI_API_KEY"
  "N8N_API_KEY"
  "sk-proj-"
  "eyJhbGci"
  "password.*="
)

# ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº staged Ñ„Ð°Ð¹Ð»Ð¾Ð²
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°
FOUND_SECRETS=0
for file in $STAGED_FILES; do
  # ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
  if file "$file" | grep -q "text"; then
    for pattern in "${PATTERNS[@]}"; do
      if grep -iE "$pattern" "$file" > /dev/null 2>&1; then
        echo "  âŒ WARNING: Possible credential found in $file (pattern: $pattern)"
        FOUND_SECRETS=1
      fi
    done
  fi
done

# Ð•ÑÐ»Ð¸ Ð½Ð°ÑˆÐ»Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ - Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ´Ð¸Ñ‚ÑŒ
if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo "  âš ï¸  DANGER: Possible credentials detected!"
  echo "  Review the files above before committing."
  echo ""
  read -p "  Do you want to continue anyway? (yes/no): " choice
  case "$choice" in
    yes|YES|Y|y )
      echo "  âš ï¸  Proceeding with commit (use caution!)"
      ;;
    * )
      echo "  âŒ Commit aborted. Remove credentials and try again."
      exit 1
      ;;
  esac
fi

# ============================================
# 2ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (>5MB)
# ============================================

echo "  Checking for large files..."

MAX_SIZE=5242880  # 5MB in bytes
LARGE_FILES=0

for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    SIZE=$(wc -c < "$file")
    if [ "$SIZE" -gt "$MAX_SIZE" ]; then
      echo "  âš ï¸  Large file detected: $file ($(($SIZE / 1024 / 1024))MB)"
      LARGE_FILES=1
    fi
  fi
done

if [ $LARGE_FILES -eq 1 ]; then
  echo ""
  read -p "  Large files detected. Continue? (yes/no): " choice
  case "$choice" in
    yes|YES|Y|y )
      echo "  Proceeding with commit"
      ;;
    * )
      echo "  âŒ Commit aborted."
      exit 1
      ;;
  esac
fi

# ============================================
# 3ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð½Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ .env Ñ„Ð°Ð¹Ð»Ñ‹
# ============================================

echo "  Checking for .env files..."

ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env$|\.env\.')
if [ ! -z "$ENV_FILES" ]; then
  echo "  âŒ ERROR: .env files should not be committed!"
  echo "  Files:"
  echo "$ENV_FILES"
  echo ""
  echo "  Add to .gitignore and remove from staging:"
  echo "  git reset HEAD .env*"
  exit 1
fi

echo "âœ… Pre-commit checks passed!"
echo ""
