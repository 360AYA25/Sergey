#!/bin/bash

# üöÄ Pre-push hook - checks before push
# Installation: copy to .git/hooks/pre-push and chmod +x

echo "üöÄ Running pre-push checks..."

# ============================================
# 1Ô∏è‚É£ Check that branch is not main/master
# ============================================

BRANCH=$(git symbolic-ref --short HEAD)

if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  # Check if running in interactive terminal
  if [ -t 0 ]; then
    # Interactive mode - ask user
    echo ""
    echo "  ‚ö†Ô∏è  WARNING: You are pushing to $BRANCH branch!"
    echo ""
    read -p "  Are you sure you want to push to $BRANCH? (yes/no): " choice
    case "$choice" in
      yes|YES|Y|y )
        echo "  Proceeding with push to $BRANCH"
        ;;
      * )
        echo "  ‚ùå Push aborted."
        exit 1
        ;;
    esac
  else
    # Non-interactive (VS Code, etc.) - check env variable
    if [ "$ALLOW_MAIN_PUSH" = "true" ]; then
      echo "  ‚úÖ Push to $BRANCH allowed (ALLOW_MAIN_PUSH=true)"
    else
      echo ""
      echo "  ‚ö†Ô∏è  WARNING: Pushing to $BRANCH from non-interactive terminal!"
      echo "  This is your main project documentation repo - proceeding."
      echo ""
      # Allow push to main for Sergey project (documentation repo)
    fi
  fi
fi

# ============================================
# 2Ô∏è‚É£ Check for WIP/TODO commits
# ============================================

echo "  Checking for WIP/TODO commits..."

# Get commits that will be pushed
COMMITS=$(git log @{u}.. --oneline 2>/dev/null)

if echo "$COMMITS" | grep -qiE "WIP|TODO|FIXME|TEMP"; then
  echo ""
  echo "  ‚ö†Ô∏è  WARNING: Found WIP/TODO/FIXME commits:"
  echo "$COMMITS" | grep -iE "WIP|TODO|FIXME|TEMP"
  echo ""
  read -p "  Push anyway? (yes/no): " choice
  case "$choice" in
    yes|YES|Y|y )
      echo "  Proceeding with push"
      ;;
    * )
      echo "  ‚ùå Push aborted. Clean up commits and try again."
      exit 1
      ;;
  esac
fi

echo "‚úÖ Pre-push checks passed!"
echo ""
